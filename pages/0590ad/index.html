<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>快速学会分析SQL执行效率 | ily55421</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="https://cdn.staticaly.com/gh/eryajf/tu/main/img/image_20220720_132133.ico">
    <script language="javascript" type="text/javascript" src="/js/pgmanor-self.js"></script>
    <meta name="description" content="💻学习📝记录🔗分享
学无止境是永远前进的基础，跃然纸上是对知识的总结交代，与众分享则是实现价值的最好方式。">
    <meta name="keywords" content="ily55421,golang,vue,go-web,go-admin,go-ldap-admin">
    <meta name="theme-color" content="#11a8cd">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <link rel="preload" href="/assets/css/0.styles.3485cdbd.css" as="style"><link rel="preload" href="/assets/js/app.7d303452.js" as="script"><link rel="preload" href="/assets/js/5.5ca26c73.js" as="script"><link rel="preload" href="/assets/js/43.95fe06e5.js" as="script"><link rel="prefetch" href="/assets/js/10.32a16328.js"><link rel="prefetch" href="/assets/js/11.51f4dee0.js"><link rel="prefetch" href="/assets/js/12.47439b7b.js"><link rel="prefetch" href="/assets/js/13.fa6da581.js"><link rel="prefetch" href="/assets/js/14.a4af8b3e.js"><link rel="prefetch" href="/assets/js/15.1bac7980.js"><link rel="prefetch" href="/assets/js/16.c546c54e.js"><link rel="prefetch" href="/assets/js/17.f20cd564.js"><link rel="prefetch" href="/assets/js/18.24c1e8fa.js"><link rel="prefetch" href="/assets/js/19.f7f3859c.js"><link rel="prefetch" href="/assets/js/20.fdd42e3d.js"><link rel="prefetch" href="/assets/js/21.6ba6a340.js"><link rel="prefetch" href="/assets/js/22.9cecd4c0.js"><link rel="prefetch" href="/assets/js/23.226ec0a8.js"><link rel="prefetch" href="/assets/js/24.61460762.js"><link rel="prefetch" href="/assets/js/25.959b24cf.js"><link rel="prefetch" href="/assets/js/26.13687b6c.js"><link rel="prefetch" href="/assets/js/27.9d170506.js"><link rel="prefetch" href="/assets/js/28.dc7ad8e9.js"><link rel="prefetch" href="/assets/js/29.c282dc5f.js"><link rel="prefetch" href="/assets/js/30.5ac0a703.js"><link rel="prefetch" href="/assets/js/31.9be53d81.js"><link rel="prefetch" href="/assets/js/32.af321aa9.js"><link rel="prefetch" href="/assets/js/33.22323cf2.js"><link rel="prefetch" href="/assets/js/34.27b04db7.js"><link rel="prefetch" href="/assets/js/35.9c17aaa6.js"><link rel="prefetch" href="/assets/js/36.c96448a2.js"><link rel="prefetch" href="/assets/js/37.52426c49.js"><link rel="prefetch" href="/assets/js/38.3b48a828.js"><link rel="prefetch" href="/assets/js/39.ca2ac16d.js"><link rel="prefetch" href="/assets/js/40.433e390b.js"><link rel="prefetch" href="/assets/js/41.eaffc214.js"><link rel="prefetch" href="/assets/js/42.74ae3b99.js"><link rel="prefetch" href="/assets/js/44.2d1d3a17.js"><link rel="prefetch" href="/assets/js/45.7533ec50.js"><link rel="prefetch" href="/assets/js/46.996e3dc6.js"><link rel="prefetch" href="/assets/js/47.b0f0b432.js"><link rel="prefetch" href="/assets/js/48.c5798cab.js"><link rel="prefetch" href="/assets/js/49.810367c4.js"><link rel="prefetch" href="/assets/js/50.94df25a8.js"><link rel="prefetch" href="/assets/js/51.519e0fa3.js"><link rel="prefetch" href="/assets/js/52.4d3b6457.js"><link rel="prefetch" href="/assets/js/53.2435b9f6.js"><link rel="prefetch" href="/assets/js/54.e740a6d3.js"><link rel="prefetch" href="/assets/js/55.15ee1ee7.js"><link rel="prefetch" href="/assets/js/56.e0786062.js"><link rel="prefetch" href="/assets/js/57.d096558c.js"><link rel="prefetch" href="/assets/js/58.1ddbe198.js"><link rel="prefetch" href="/assets/js/59.cddfae60.js"><link rel="prefetch" href="/assets/js/6.3396a9ee.js"><link rel="prefetch" href="/assets/js/60.7153e854.js"><link rel="prefetch" href="/assets/js/61.6a9d1e6b.js"><link rel="prefetch" href="/assets/js/62.7163655c.js"><link rel="prefetch" href="/assets/js/63.233025d8.js"><link rel="prefetch" href="/assets/js/64.8acdf960.js"><link rel="prefetch" href="/assets/js/65.21ffb00b.js"><link rel="prefetch" href="/assets/js/66.b61bcbe7.js"><link rel="prefetch" href="/assets/js/67.5a4373f4.js"><link rel="prefetch" href="/assets/js/68.5fc2f918.js"><link rel="prefetch" href="/assets/js/69.89b9f203.js"><link rel="prefetch" href="/assets/js/7.0d4d4fc2.js"><link rel="prefetch" href="/assets/js/70.aabdd5f2.js"><link rel="prefetch" href="/assets/js/71.b6915fdf.js"><link rel="prefetch" href="/assets/js/72.da3c82f2.js"><link rel="prefetch" href="/assets/js/73.8fa05628.js"><link rel="prefetch" href="/assets/js/74.c3624110.js"><link rel="prefetch" href="/assets/js/75.d7c29eb8.js"><link rel="prefetch" href="/assets/js/76.7a9eb09f.js"><link rel="prefetch" href="/assets/js/77.b2117079.js"><link rel="prefetch" href="/assets/js/78.52262f79.js"><link rel="prefetch" href="/assets/js/79.8f1945d3.js"><link rel="prefetch" href="/assets/js/8.26c87b90.js"><link rel="prefetch" href="/assets/js/80.9923e78a.js"><link rel="prefetch" href="/assets/js/81.c958c9d5.js"><link rel="prefetch" href="/assets/js/82.89821ab1.js"><link rel="prefetch" href="/assets/js/83.98c3c37f.js"><link rel="prefetch" href="/assets/js/84.7687ff76.js"><link rel="prefetch" href="/assets/js/85.fe2ec9a4.js"><link rel="prefetch" href="/assets/js/86.9f18d8e8.js"><link rel="prefetch" href="/assets/js/87.aa04c866.js"><link rel="prefetch" href="/assets/js/88.95a9ae6a.js"><link rel="prefetch" href="/assets/js/89.b995f813.js"><link rel="prefetch" href="/assets/js/9.6c002df9.js"><link rel="prefetch" href="/assets/js/90.4d87b2a1.js"><link rel="prefetch" href="/assets/js/91.90e5c75d.js"><link rel="prefetch" href="/assets/js/92.0fab5248.js"><link rel="prefetch" href="/assets/js/93.493feb99.js"><link rel="prefetch" href="/assets/js/94.0cae0a06.js"><link rel="prefetch" href="/assets/js/95.2a217ab7.js"><link rel="prefetch" href="/assets/js/96.362f53ea.js"><link rel="prefetch" href="/assets/js/mermaid.f2857331.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.c013cef0.js"><link rel="prefetch" href="/assets/js/vendors~mermaid.23884ed8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3485cdbd.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://cdn.staticaly.com/gh/eryajf/tu/main/img/image_20220720_132208.png" alt="ily55421" class="logo"> <span class="site-name can-hide">ily55421</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法与数据结构" class="dropdown-title"><a href="/algorithm/" class="link-title">算法与数据结构</a> <span class="title" style="display:none;">算法与数据结构</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/24768e/" class="nav-link">算法</a></li><li class="dropdown-item"><!----> <a href="/pages/24770e/" class="nav-link">数据结构</a></li><li class="dropdown-item"><!----> <a href="/pages/040924/" class="nav-link">刷题</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专题" class="dropdown-title"><a href="/topic/" class="link-title">专题</a> <span class="title" style="display:none;">专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/a4770e/" class="nav-link">专题文章</a></li><li class="dropdown-item"><!----> <a href="/pages/678015/" class="nav-link">Java系列</a></li><li class="dropdown-item"><!----> <a href="/pages/0590ad/" aria-current="page" class="nav-link router-link-exact-active router-link-active">Mysql系列</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="生活" class="dropdown-title"><a href="/life/" class="link-title">生活</a> <span class="title" style="display:none;">生活</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/bc7034/" class="nav-link">最佳实践</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程" class="dropdown-title"><a href="/code/" class="link-title">编程</a> <span class="title" style="display:none;">编程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/ace3fe/" class="nav-link">JAVA</a></li><li class="dropdown-item"><h4>JVM</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/f2e80b/" class="nav-link">Java虚拟机基本原理</a></li><li class="dropdown-subitem"><a href="/pages/bf46c5/" class="nav-link">高效编译</a></li><li class="dropdown-subitem"><a href="/pages/1261df/" class="nav-link">代码优化</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/categories/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><a href="/message-board/" class="nav-link">留言板</a></div><div class="nav-item"><a href="https://ily55421.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  我的博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com//" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法与数据结构" class="dropdown-title"><a href="/algorithm/" class="link-title">算法与数据结构</a> <span class="title" style="display:none;">算法与数据结构</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/24768e/" class="nav-link">算法</a></li><li class="dropdown-item"><!----> <a href="/pages/24770e/" class="nav-link">数据结构</a></li><li class="dropdown-item"><!----> <a href="/pages/040924/" class="nav-link">刷题</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专题" class="dropdown-title"><a href="/topic/" class="link-title">专题</a> <span class="title" style="display:none;">专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/a4770e/" class="nav-link">专题文章</a></li><li class="dropdown-item"><!----> <a href="/pages/678015/" class="nav-link">Java系列</a></li><li class="dropdown-item"><!----> <a href="/pages/0590ad/" aria-current="page" class="nav-link router-link-exact-active router-link-active">Mysql系列</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="生活" class="dropdown-title"><a href="/life/" class="link-title">生活</a> <span class="title" style="display:none;">生活</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/bc7034/" class="nav-link">最佳实践</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程" class="dropdown-title"><a href="/code/" class="link-title">编程</a> <span class="title" style="display:none;">编程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/ace3fe/" class="nav-link">JAVA</a></li><li class="dropdown-item"><h4>JVM</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/f2e80b/" class="nav-link">Java虚拟机基本原理</a></li><li class="dropdown-subitem"><a href="/pages/bf46c5/" class="nav-link">高效编译</a></li><li class="dropdown-subitem"><a href="/pages/1261df/" class="nav-link">代码优化</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/categories/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><a href="/message-board/" class="nav-link">留言板</a></div><div class="nav-item"><a href="https://ily55421.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  我的博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com//" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>专题文章</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Mysql系列</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/0590ad/" aria-current="page" class="active sidebar-link">快速学会分析SQL执行效率</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/0590ad/#_1-定位慢-sql" class="sidebar-link">1 定位慢 SQL</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/0590ad/#_1-1-通过慢查询日志" class="sidebar-link">1.1 通过慢查询日志</a></li><li class="sidebar-sub-header level3"><a href="/pages/0590ad/#_1-2-通过-show-processlist" class="sidebar-link">1.2 通过 show processlist;</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/0590ad/#_2-使用-explain-分析慢查询" class="sidebar-link">2 使用 explain 分析慢查询</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/0590ad/#_2-1-select-type" class="sidebar-link">2.1 select_type</a></li><li class="sidebar-sub-header level3"><a href="/pages/0590ad/#_2-2-type" class="sidebar-link">2.2 type</a></li><li class="sidebar-sub-header level3"><a href="/pages/0590ad/#_2-3-extra" class="sidebar-link">2.3 Extra</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/0590ad/#_1-show-profile-分析慢查询" class="sidebar-link">1 show profile 分析慢查询</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/0590ad/#_1-1-确定是否支持-profile" class="sidebar-link">1.1 确定是否支持 profile</a></li><li class="sidebar-sub-header level3"><a href="/pages/0590ad/#_1-2-查看-profiling-是否关闭的" class="sidebar-link">1.2 查看 profiling 是否关闭的</a></li><li class="sidebar-sub-header level3"><a href="/pages/0590ad/#_1-3-通过-set-开启-profile" class="sidebar-link">1.3 通过 set 开启 profile</a></li><li class="sidebar-sub-header level3"><a href="/pages/0590ad/#_1-4-执行-sql-语句" class="sidebar-link">1.4 执行 SQL 语句</a></li><li class="sidebar-sub-header level3"><a href="/pages/0590ad/#_1-5-确定-sql-的-query-id" class="sidebar-link">1.5 确定 SQL 的 query id</a></li><li class="sidebar-sub-header level3"><a href="/pages/0590ad/#_1-6-查询-sql-执行详情" class="sidebar-link">1.6 查询 SQL 执行详情</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/0590ad/#_2-trace-分析-sql-优化器" class="sidebar-link">2 trace 分析 SQL 优化器</a></li><li class="sidebar-sub-header level2"><a href="/pages/0590ad/#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header level2"><a href="/pages/0590ad/#_5-参考资料" class="sidebar-link">5 参考资料</a></li></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=%E7%B3%BB%E5%88%97%E4%B8%93%E9%A2%98" title="分类" data-v-06225672>系列专题</a></li><li data-v-06225672><a href="/categories/?category=Mysql%E7%B3%BB%E5%88%97" title="分类" data-v-06225672>Mysql系列</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/ily55421" target="_blank" title="作者" class="beLink" data-v-06225672>ily55421</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-12-04</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">快速学会分析SQL执行效率<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="快速学会分析sql执行效率-上"><a href="#快速学会分析sql执行效率-上" class="header-anchor">#</a> 快速学会分析SQL执行效率（上）</h1> <p>勤学如春起之苗，不见其增，日有所长。</p> <p>——陶潜</p> <p>从开篇词我们了解到，本专栏首先会一起讨论一下 SQL 优化，而优化 SQL 的前提是能定位到慢 SQL 并对其进行分析，因此在专栏的开始，会跟大家分享<strong>如何定位慢查询和如何分析 SQl 执行效率</strong>。在前面两节，会用一些简单的例子让大家学会这些分析技巧。</p> <p>在工作中可能会遇到某个新功能在测试时需要很久才返回结果，这时就应该分析是不是慢查询导致的。如果确实有慢查询，又应该怎么去分析 SQL 执行效率呢？这一篇文章我们就来学习怎么找到慢查询和怎么分析 SQL 执行效率。</p> <h2 id="_1-定位慢-sql"><a href="#_1-定位慢-sql" class="header-anchor">#</a> 1 定位慢 SQL</h2> <p>当我们实际工作中，碰到某个功能或者某个接口需要很久才能返回结果，我们就应该去确定是不是慢查询导致的。定位慢 SQL 有如下两种解决方案：</p> <ul><li>查看慢查询日志确定已经执行完的慢查询</li> <li>show processlist 查看正在执行的慢查询</li></ul> <p>我们一起来了解下这两种方法的使用场景和使用技巧吧！</p> <h3 id="_1-1-通过慢查询日志"><a href="#_1-1-通过慢查询日志" class="header-anchor">#</a> 1.1 通过慢查询日志</h3> <p>如果需要定位到慢查询，一般的方法是通过慢查询日志来查询的，MySQL 的慢查询日志用来记录在 MySQL 中响应时间超过参数 long_query_time（单位秒，默认值 10）设置的值并且扫描记录数不小于  min_examined_row_limit（默认值0）的语句，<strong>能够帮我们找到执行完的慢查询，方便我们对这些 SQL 进行优化</strong>。</p> <blockquote><p>知识扩展：</p> <p>默认情况下，慢查询日志中不会记录管理语句，可通过设置 log_slow_admin_statements = on 让管理语句中的慢查询也会记录到慢查询日志中。</p> <p>默认情况下，也不会记录查询时间不超过  long_query_time 但是不使用索引的语句，可通过配置log_queries_not_using_indexes = on  让不使用索引的 SQL 都被记录到慢查询日志中（即使查询时间没超过 long_query_time 配置的值）。</p></blockquote> <p>如果需要使用慢查询日志，一般分为四步：开启慢查询日志、设置慢查询阀值、确定慢查询日志路径、确定慢查询日志的文件名。下面我们来学习下:</p> <p>首先开启慢查询日志，由参数 slow_query_log 决定是否开启，在 MySQL 命令行下输入下面的命令：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> <span class="token keyword">global</span> slow_query_log <span class="token operator">=</span> <span class="token keyword">on</span><span class="token punctuation">;</span>

Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>默认环境下，慢查询日志是关闭的。</p> <p>设置慢查询时间阀值</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> <span class="token keyword">global</span> long_query_time <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>知识扩展：
<strong>MySQL 中 long_query_time 的值如何确定呢？</strong></p> <p>线上业务一般建议把 long_query_time 设置为 1 秒，如果某个业务的 MySQL 要求比较高的 QPS，可设置慢查询为 0.1 秒。发现慢查询及时优化或者提醒开发改写。</p> <p>一般测试环境建议 long_query_time 设置的阀值比生产环境的小，比如生产环境是 1 秒，则测试环境建议配置成 0.5 秒。便于在测试环境及时发现一些效率低的 SQL。</p> <p>甚至某些重要业务测试环境 long_query_time 可以设置为 0，以便记录所有语句。并留意慢查询日志的输出，上线前的功能测试完成后，分析慢查询日志每类语句的输出，重点关注 Rows_examined（语句执行期间从存储引擎读取的行数），提前优化。</p></blockquote> <p>确定慢查询日志路径</p> <p>慢查询日志的路径默认是 MySQL 的数据目录</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">global</span> variables <span class="token operator">like</span> <span class="token string">&quot;datadir&quot;</span><span class="token punctuation">;</span>

<span class="token operator">+</span><span class="token comment">---------------+------------------------+</span>
<span class="token operator">|</span> Variable_name <span class="token operator">|</span> <span class="token keyword">Value</span>                  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+------------------------+</span>
<span class="token operator">|</span> datadir       <span class="token operator">|</span> <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mysql<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span><span class="token number">3306</span><span class="token operator">/</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+------------------------+</span>

<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>确定慢查询日志的文件名</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">global</span> variables <span class="token operator">like</span> <span class="token string">&quot;slow_query_log_file&quot;</span><span class="token punctuation">;</span>

<span class="token operator">+</span><span class="token comment">---------------------+----------------+</span>
<span class="token operator">|</span> Variable_name       <span class="token operator">|</span> <span class="token keyword">Value</span>          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+----------------+</span>
<span class="token operator">|</span> slow_query_log_file <span class="token operator">|</span> mysql<span class="token operator">-</span>slow<span class="token punctuation">.</span>log <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+----------------+</span>

<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>根据上面的查询结果，可以直接查看 /data/mysql/data/3306/mysql-slow.log 文件获取已经执行完的慢查询</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token punctuation">[</span>root<span class="token variable">@mysqltest</span> <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># tail -n5 /data/mysql/data/3306/mysql-slow.log</span>

<span class="token keyword">Time</span>: <span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">21</span>T09:<span class="token number">15</span>:<span class="token number">06.255554</span><span class="token operator">+</span><span class="token number">08</span>:<span class="token number">00</span>

<span class="token keyword">User</span><span class="token variable">@Host</span>: root<span class="token punctuation">[</span>root<span class="token punctuation">]</span> @ localhost <span class="token punctuation">[</span><span class="token punctuation">]</span>  Id: <span class="token number">8591152</span>

Query_time: <span class="token number">10.000260</span>  Lock_time: <span class="token number">0.000000</span> Rows_sent: <span class="token number">1</span>  Rows_examined: <span class="token number">0</span>

<span class="token keyword">SET</span> <span class="token keyword">timestamp</span><span class="token operator">=</span><span class="token number">1558401306</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这里对上方的执行结果详细描述一下：</p> <ul><li>tail  -n5：只查看慢查询文件的最后5行</li> <li>Time：慢查询发生的时间</li> <li>User@Host：客户端用户和IP</li> <li>Query_time：查询时间</li> <li>Lock_time：等待表锁的时间</li> <li>Rows_sent：语句返回的行数</li> <li>Rows_examined：语句执行期间从存储引擎读取的行数</li></ul> <p>上面这种方式是用系统自带的慢查询日志查看的，如果觉得系统自带的慢查询日志不方便查看，小伙伴们可以使用 pt-query-digest 或者 mysqldumpslow 等工具对慢查询日志进行分析，由于本节重点是找到慢查询，这里就不一一示例了。</p> <h3 id="_1-2-通过-show-processlist"><a href="#_1-2-通过-show-processlist" class="header-anchor">#</a> 1.2 通过 show processlist;</h3> <p>有时慢查询正在执行，已经导致数据库负载偏高了，而由于慢查询还没执行完，因此慢查询日志还看不到任何语句。此时可以使用 show processlist 命令判断正在执行的慢查询。show processlist 显示哪些线程正在运行。如果有 PROCESS  权限，则可以看到所有线程。否则，只能看到当前会话的线程。</p> <blockquote><p>知识扩展：如果不使用 FULL 关键字，在 info 字段中只显示每个语句的前 100 个字符，如果想看语句的全部内容可以使用 full 修饰（show full processlist）。</p></blockquote> <p>执行结果如下：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> processlist\G<span class="token identifier"><span class="token punctuation">`</span>

<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>

<span class="token punctuation">`</span></span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">10.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token identifier"><span class="token punctuation">`</span>

     <span class="token punctuation">`</span></span>Id: <span class="token number">7651833</span><span class="token identifier"><span class="token punctuation">`</span>

   <span class="token punctuation">`</span></span><span class="token keyword">User</span>: one<span class="token identifier"><span class="token punctuation">`</span>

   <span class="token punctuation">`</span></span>Host: <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.251</span>:<span class="token number">52154</span><span class="token identifier"><span class="token punctuation">`</span>

     <span class="token punctuation">`</span></span>db: ops<span class="token identifier"><span class="token punctuation">`</span>

<span class="token punctuation">`</span></span>Command: Query<span class="token identifier"><span class="token punctuation">`</span>

   <span class="token punctuation">`</span></span><span class="token keyword">Time</span>: <span class="token number">3</span><span class="token identifier"><span class="token punctuation">`</span>

  <span class="token punctuation">`</span></span>State: <span class="token keyword">User</span> sleep<span class="token identifier"><span class="token punctuation">`</span>

   <span class="token punctuation">`</span></span>Info: <span class="token keyword">select</span> sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token identifier"><span class="token punctuation">`</span>

<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>

<span class="token punctuation">`</span></span><span class="token number">10</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token punctuation">`</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>这里对上面结果解释一下：</p> <ul><li>Time：表示执行时间</li> <li>Info：表示 SQL 语句</li></ul> <p>我们这里可以通过它的执行时间（Time）来判断是否是慢 SQL。</p> <h2 id="_2-使用-explain-分析慢查询"><a href="#_2-使用-explain-分析慢查询" class="header-anchor">#</a> 2 使用 explain 分析慢查询</h2> <p>分析 SQL 执行效率是优化 SQL 的重要手段，通过上面讲的两种方法，定位到慢查询语句后，我们就要开始分析 SQL  执行效率了，子曾经曰过：“工欲善其事，必先利其器”，我们可以通过 explain、show profile 和 trace  等诊断工具来分析慢查询。本节先讲解 explain 的使用，在下节将分享 show profile 和 trace 的使用。</p> <p>Explain 可以获取 MySQL 中 SQL 语句的执行计划，比如语句是否使用了关联查询、是否使用了索引、扫描行数等。可以帮我们选择更好地索引和写出更优的 SQL 。使用方法：在查询语句前面加上 explain 运行就可以了。</p> <p>这也是分析 SQL 时最常用的，也是作者最推荐的一种分析慢查询的方式。下面我们来看下示例~~</p> <p>为了便于理解，先创建两张测试表（方便第 1、2 节实验使用），建表及数据写入语句如下：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> muke<span class="token punctuation">;</span>           <span class="token comment">/* 创建测试使用的database，名为muke */</span>
<span class="token keyword">use</span> muke<span class="token punctuation">;</span>                       <span class="token comment">/* 使用muke这个database */</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> t1<span class="token punctuation">;</span>        <span class="token comment">/* 如果表t1存在则删除表t1 */</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t1<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>             <span class="token comment">/* 创建表t1 */</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>b<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'记录创建时间'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'记录更新时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_a<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_b<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>b<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>	

<span class="token keyword">drop</span> <span class="token keyword">procedure</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> insert_t1<span class="token punctuation">;</span> <span class="token comment">/* 如果存在存储过程insert_t1，则删除 */</span>
<span class="token keyword">delimiter</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">procedure</span> insert_t1<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment">/* 创建存储过程insert_t1 */</span>
<span class="token keyword">begin</span>
  <span class="token keyword">declare</span> i <span class="token keyword">int</span><span class="token punctuation">;</span>                    <span class="token comment">/* 声明变量i */</span>
  <span class="token keyword">set</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                          <span class="token comment">/* 设置i的初始值为1 */</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">&lt;=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token keyword">do</span>                  <span class="token comment">/* 对满足i&lt;=1000的值进行while循环 */</span>
    <span class="token keyword">insert</span> <span class="token keyword">into</span> t1<span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 写入表t1中a、b两个字段，值都为i当前的值 */</span>
    <span class="token keyword">set</span> i<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>                      <span class="token comment">/* 将i加1 */</span>
  <span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">delimiter</span> <span class="token punctuation">;</span>                 <span class="token comment">/* 创建批量写入1000条数据到表t1的存储过程insert_t1 */</span>
<span class="token keyword">call</span> insert_t1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">/* 运行存储过程insert_t1 */</span>

<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> t2<span class="token punctuation">;</span>    <span class="token comment">/* 如果表t2存在则删除表t2 */</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> t2 <span class="token operator">like</span> t1<span class="token punctuation">;</span>    <span class="token comment">/* 创建表t2，表结构与t1一致 */</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t2 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1<span class="token punctuation">;</span>   <span class="token comment">/* 将表t1的数据导入到t2 */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>下面尝试使用 explain 分析一条 SQL，例子如下：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> b<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/07/29/5d3aa6eb00011e2511760160-9c4cff.jpeg" alt="图片描述"></p> <p>Explain 的结果各字段解释如下：</p> <p>加粗的列为需要重点关注的项。</p> <table><thead><tr><th>列名</th> <th>解释</th></tr></thead> <tbody><tr><td>id</td> <td>查询编号</td></tr> <tr><td><strong>select_type</strong></td> <td>查询类型：显示本行是简单还是复杂查询</td></tr> <tr><td>table</td> <td>涉及到的表</td></tr> <tr><td>partitions</td> <td>匹配的分区：查询将匹配记录所在的分区。仅当使用 partition 关键字时才显示该列。对于非分区表，该值为 NULL。</td></tr> <tr><td><strong>type</strong></td> <td>本次查询的表连接类型</td></tr> <tr><td>possible_keys</td> <td>可能选择的索引</td></tr> <tr><td><strong>key</strong></td> <td>实际选择的索引</td></tr> <tr><td>key_len</td> <td>被选择的索引长度：一般用于判断联合索引有多少列被选择了</td></tr> <tr><td>ref</td> <td>与索引比较的列</td></tr> <tr><td><strong>rows</strong></td> <td>预计需要扫描的行数，对 InnoDB 来说，这个值是估值，并不一定准确</td></tr> <tr><td>filtered</td> <td>按条件筛选的行的百分比</td></tr> <tr><td><strong>Extra</strong></td> <td>附加信息</td></tr></tbody></table> <p>表1-explain 各字段解释</p> <p>其中 explain 各列都有各种不同的值，这里介绍几个比较重要列常包含的值:包含 select_typ、type 和 Extra。</p> <p>下面将列出它们常见的一些值，可稍微过一遍，不需要完全记下来，在后续章节分析 SQL 时，可以返回查询本节内容并对比各种值的区别。</p> <h3 id="_2-1-select-type"><a href="#_2-1-select-type" class="header-anchor">#</a> 2.1 select_type</h3> <table><thead><tr><th>select_type 的值</th> <th>解释</th></tr></thead> <tbody><tr><td>SIMPLE</td> <td>简单查询(不使用关联查询或子查询)</td></tr> <tr><td>PRIMARY</td> <td>如果包含关联查询或者子查询，则最外层的查询部分标记为primary</td></tr> <tr><td>UNION</td> <td>联合查询中第二个及后面的查询</td></tr> <tr><td>DEPENDENT   UNION</td> <td>满足依赖外部的关联查询中第二个及以后的查询</td></tr> <tr><td>UNION RESULT</td> <td>联合查询的结果</td></tr> <tr><td>SUBQUERY</td> <td>子查询中的第一个查询</td></tr> <tr><td>DEPENDENT   SUBQUERY</td> <td>子查询中的第一个查询，并且依赖外部查询</td></tr> <tr><td>DERIVED</td> <td>用到派生表的查询</td></tr> <tr><td>MATERIALIZED</td> <td>被物化的子查询</td></tr> <tr><td>UNCACHEABLE      SUBQUERY</td> <td>一个子查询的结果不能被缓存，必须重新评估外层查询的每一行</td></tr> <tr><td>UNCACHEABLE   UNION</td> <td>关联查询第二个或后面的语句属于不可缓存的子查询</td></tr></tbody></table> <p>表2-select_type 各项值解释</p> <h3 id="_2-2-type"><a href="#_2-2-type" class="header-anchor">#</a> 2.2 type</h3> <table><thead><tr><th>type的值</th> <th>解释</th></tr></thead> <tbody><tr><td>system</td> <td>查询对象表只有一行数据,且只能用于 MyISAM 和 Memory 引擎的表，这是最好的情况</td></tr> <tr><td>const</td> <td>基于主键或唯一索引查询，最多返回一条结果</td></tr> <tr><td>eq_ref</td> <td>表连接时基于主键或非 NULL 的唯一索引完成扫描</td></tr> <tr><td>ref</td> <td>基于普通索引的等值查询，或者表间等值连接</td></tr> <tr><td>fulltext</td> <td>全文检索</td></tr> <tr><td>ref_or_null</td> <td>表连接类型是 ref，但进行扫描的索引列中可能包含 NULL 值</td></tr> <tr><td>index_merge</td> <td>利用多个索引</td></tr> <tr><td>unique_subquery</td> <td>子查询中使用唯一索引</td></tr> <tr><td>index_subquery</td> <td>子查询中使用普通索引</td></tr> <tr><td>range</td> <td>利用索引进行范围查询</td></tr> <tr><td>index</td> <td>全索引扫描</td></tr> <tr><td>ALL</td> <td>全表扫描</td></tr></tbody></table> <p>表3-type 各项值解释</p> <p><strong>上表的这些情况，查询性能从上到下依次是最好到最差。</strong></p> <h3 id="_2-3-extra"><a href="#_2-3-extra" class="header-anchor">#</a> 2.3 Extra</h3> <table><thead><tr><th>Extra 常见的值</th> <th>解释</th> <th>例子</th></tr></thead> <tbody><tr><td>Using filesort</td> <td>将用外部排序而不是索引排序，数据较小时从内存排序，否则需要在磁盘完成排序</td> <td>explain select * from   t1 order  by create_time;</td></tr> <tr><td>Using   temporary</td> <td>需要创建一个临时表来存储结构，通常发生对没有索引的列进行 GROUP BY 时</td> <td>explain select * from   t1 group by create_time;</td></tr> <tr><td>Using index</td> <td>使用覆盖索引</td> <td>explain select a from   t1 where a=111;</td></tr> <tr><td>Using where</td> <td>使用 where 语句来处理结果</td> <td>explain select * from t1 where create_time=‘2019-06-18 14:38:24’;</td></tr> <tr><td>Impossible   WHERE</td> <td>对 where 子句判断的结果总是 false 而不能选择任何数据</td> <td>explain select * from t1 where 1&lt;0;</td></tr> <tr><td>Using join   buffer (Block Nested Loop)</td> <td>关联查询中，被驱动表的关联字段没索引</td> <td>explain   select * from t1 straight_join t2 on (t1.create_time=t2.create_time);</td></tr> <tr><td>Using index   condition</td> <td>先条件过滤索引，再查数据</td> <td>explain   select * from t1 where a &gt;900 and a like “%9”;</td></tr> <tr><td>Select tables   optimized away</td> <td>使用某些聚合函数（比如 max、min）来访问存在索引的某个字段是</td> <td>explain select max(a)   from t1;</td></tr></tbody></table> <p>表4-Extra 常见值解释及举例</p> <h2 id="_1-show-profile-分析慢查询"><a href="#_1-show-profile-分析慢查询" class="header-anchor">#</a> 1 show profile 分析慢查询</h2> <p>有时需要确定 SQL 到底慢在哪个环节，此时 explain 可能不好确定。在 MySQL 数据库中，通过 profile，能够更清楚地了解 SQL 执行过程的资源使用情况，能让我们知道到底慢在哪个环节。</p> <blockquote><p>知识扩展：可以通过配置参数 profiling = 1 来启用 SQL 分析。该参数可以在全局和 session 级别来设置。对于全局级别则作用于整个MySQL 实例，而 session 级别仅影响当前 session 。该参数开启后，后续<strong>执行的 SQL 语句都将记录其资源开销，如 IO、上下文切换、CPU、Memory</strong>等等。根据这些开销进一步分析当前 SQL 从而进行优化与调整。</p></blockquote> <p>下面我们来讲一下如何使用 profile 分析慢查询，大致步骤是：确定这个 MySQL 版本是否支持 profile；确定 profile 是否关闭；开启  profile；执行 SQL；查看执行完 SQL 的 query id；通过 query id 查看 SQL 的每个状态及耗时时间。</p> <h3 id="_1-1-确定是否支持-profile"><a href="#_1-1-确定是否支持-profile" class="header-anchor">#</a> 1.1 确定是否支持 profile</h3> <p>我们进行第一步，用下面命令来判断当前 MySQL 是否支持 profile：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @<span class="token variable">@have_profiling</span><span class="token punctuation">;</span>

<span class="token operator">+</span><span class="token comment">------------------+</span>
<span class="token operator">|</span> @<span class="token variable">@have_profiling</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+</span>
<span class="token operator">|</span> YES              <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+</span>

<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>从上面结果中可以看出是YES，表示支持profile的。</p> <h3 id="_1-2-查看-profiling-是否关闭的"><a href="#_1-2-查看-profiling-是否关闭的" class="header-anchor">#</a> 1.2 查看 profiling 是否关闭的</h3> <p>进行第二步，用下面命令判断 profiling 参数是否关闭（默认 profiling 是关闭的）：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @<span class="token variable">@profiling</span><span class="token punctuation">;</span>

<span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span> @<span class="token variable">@profiling</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>

<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>结果显示为 0，表示 profiling 参数状态是关闭的。</p> <h3 id="_1-3-通过-set-开启-profile"><a href="#_1-3-通过-set-开启-profile" class="header-anchor">#</a> 1.3 通过 set 开启 profile</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> profiling<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>

Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected<span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Tips：set 时没加 global，只对当前 session 有效。</p> <h3 id="_1-4-执行-sql-语句"><a href="#_1-4-执行-sql-语句" class="header-anchor">#</a> 1.4 执行 SQL 语句</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> b<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_1-5-确定-sql-的-query-id"><a href="#_1-5-确定-sql-的-query-id" class="header-anchor">#</a> 1.5 确定 SQL 的 query id</h3> <p>通过 show profiles 语句确定执行过的 SQL 的 query id：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> profiles<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------+------------+-------------------------------+</span>
<span class="token operator">|</span> Query_ID <span class="token operator">|</span> Duration   <span class="token operator">|</span> Query                         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+------------+-------------------------------+</span>
<span class="token operator">|</span>        <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">0.00063825</span> <span class="token operator">|</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> b<span class="token operator">=</span><span class="token number">1000</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+------------+-------------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_1-6-查询-sql-执行详情"><a href="#_1-6-查询-sql-执行详情" class="header-anchor">#</a> 1.6 查询 SQL 执行详情</h3> <p>通过 show profile for query 可看到执行过的 SQL 每个状态和消耗时间：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> profile <span class="token keyword">for</span> query <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------------------+----------+</span>
<span class="token operator">|</span> <span class="token keyword">Status</span>               <span class="token operator">|</span> Duration <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------+----------+</span>
<span class="token operator">|</span> <span class="token keyword">starting</span>             <span class="token operator">|</span> <span class="token number">0.000115</span> <span class="token operator">|</span>
<span class="token operator">|</span> checking permissions <span class="token operator">|</span> <span class="token number">0.000013</span> <span class="token operator">|</span>
<span class="token operator">|</span> Opening <span class="token keyword">tables</span>       <span class="token operator">|</span> <span class="token number">0.000027</span> <span class="token operator">|</span>
<span class="token operator">|</span> init                 <span class="token operator">|</span> <span class="token number">0.000035</span> <span class="token operator">|</span>
<span class="token operator">|</span> System <span class="token keyword">lock</span>          <span class="token operator">|</span> <span class="token number">0.000017</span> <span class="token operator">|</span>
<span class="token operator">|</span> optimizing           <span class="token operator">|</span> <span class="token number">0.000016</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token keyword">statistics</span>           <span class="token operator">|</span> <span class="token number">0.000025</span> <span class="token operator">|</span>
<span class="token operator">|</span> preparing            <span class="token operator">|</span> <span class="token number">0.000020</span> <span class="token operator">|</span>
<span class="token operator">|</span> executing            <span class="token operator">|</span> <span class="token number">0.000006</span> <span class="token operator">|</span>
<span class="token operator">|</span> Sending <span class="token keyword">data</span>         <span class="token operator">|</span> <span class="token number">0.000294</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token keyword">end</span>                  <span class="token operator">|</span> <span class="token number">0.000009</span> <span class="token operator">|</span>
<span class="token operator">|</span> query <span class="token keyword">end</span>            <span class="token operator">|</span> <span class="token number">0.000012</span> <span class="token operator">|</span>
<span class="token operator">|</span> closing <span class="token keyword">tables</span>       <span class="token operator">|</span> <span class="token number">0.000011</span> <span class="token operator">|</span>
<span class="token operator">|</span> freeing items        <span class="token operator">|</span> <span class="token number">0.000024</span> <span class="token operator">|</span>
<span class="token operator">|</span> cleaning up          <span class="token operator">|</span> <span class="token number">0.000016</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------+----------+</span>
<span class="token number">15</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>通过以上结果，可以确定 SQL 执行过程具体在哪个过程耗时比较久，从而更好地进行 SQL 优化与调整。</p> <h2 id="_2-trace-分析-sql-优化器"><a href="#_2-trace-分析-sql-优化器" class="header-anchor">#</a> 2 trace 分析 SQL 优化器</h2> <p>从前面学到了 explain 可以查看 SQL 执行计划，但是无法知道它为什么做这个决策，如果想确定多种索引方案之间是如何选择的或者排序时选择的是哪种排序模式，有什么好的办法吗？</p> <p>从 MySQL 5.6 开始，可以使用 trace 查看优化器如何选择执行计划。</p> <p>通过trace，能够进一步了解为什么优化器选择A执行计划而不是选择B执行计划，或者知道某个排序使用的排序模式，帮助我们更好地理解优化器行为。</p> <p>如果需要使用，先开启 trace，设置格式为 JSON，再执行需要分析的 SQL，最后查看 trace 分析结果（在 information_schema.OPTIMIZER_TRACE 中）。</p> <p>开启该功能，会对 MySQL 性能有所影响，因此只建议分析问题时临时开启。</p> <p>下面一起来看下 trace 的使用方法。使用讲解 explain 时创建的表t1做实验。</p> <p>首先构造如下 SQL (表示取出表 t1 中 a 的值大于 900 并且 b 的值大于 910 的数据，然后按照 a 字段排序)：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> a <span class="token operator">&gt;</span><span class="token number">900</span> <span class="token operator">and</span> b <span class="token operator">&gt;</span> <span class="token number">910</span> <span class="token keyword">order</span>  <span class="token keyword">by</span> a<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们首先用 explain 分析下执行计划：
<img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/07/29/5d3aa9480001b8b316420165-3cf8cd.jpeg" alt="图片描述">通过上面执行计划中 key 这个字段可以看出，该语句使用的是 b 字段的索引 idx_b。实际表 t1 中，a、b 两个字段都有索引，为什么条件中有这两个索引字段却偏偏选了 b 字段的索引呢？这时就可以使用 trace 进行分析。大致步骤如下：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> <span class="token keyword">session</span> optimizer_trace<span class="token operator">=</span><span class="token string">&quot;enabled=on&quot;</span><span class="token punctuation">,</span>end_markers_in_json<span class="token operator">=</span><span class="token keyword">on</span><span class="token punctuation">;</span>
<span class="token comment">/* optimizer_trace=&quot;enabled=on&quot; 表示开启 trace；end_markers_in_json=on 表示 JSON 输出开启结束标记 */</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> a <span class="token operator">&gt;</span><span class="token number">900</span> <span class="token operator">and</span> b <span class="token operator">&gt;</span> <span class="token number">910</span> <span class="token keyword">order</span>  <span class="token keyword">by</span> a<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+------+------+</span>
<span class="token operator">|</span> id   <span class="token operator">|</span> a    <span class="token operator">|</span> b    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+------+</span>
<span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token operator">|</span> <span class="token number">1000</span> <span class="token operator">|</span> <span class="token number">1000</span> <span class="token operator">|</span> <span class="token number">1000</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+------+</span>
<span class="token number">1000</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>OPTIMIZER_TRACE\G
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
QUERY: <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> a <span class="token operator">&gt;</span><span class="token number">900</span> <span class="token operator">and</span> b <span class="token operator">&gt;</span> <span class="token number">910</span> <span class="token keyword">order</span>  <span class="token keyword">by</span> a    <span class="token comment">--SQL语句</span>
TRACE: {
  <span class="token string">&quot;steps&quot;</span>: <span class="token punctuation">[</span>
    {
      <span class="token string">&quot;join_preparation&quot;</span>: {				<span class="token comment">--SQL准备阶段</span>
        <span class="token string">&quot;select#&quot;</span>: <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">&quot;steps&quot;</span>: <span class="token punctuation">[</span>
          {
            <span class="token string">&quot;expanded_query&quot;</span>: <span class="token string">&quot;/* select#1 */ select `t1`.`id` AS `id`,`t1`.`a` AS `a`,`t1`.`b` AS `b`,`t1`.`create_time` AS `create_time`,`t1`.`update_time` AS `update_time` from `t1` where ((`t1`.`a` &gt; 900) and (`t1`.`b` &gt; 910)) order by `t1`.`a`&quot;</span>
          }
        <span class="token punctuation">]</span> <span class="token comment">/* steps */</span>
      } <span class="token comment">/* join_preparation */</span>
    }<span class="token punctuation">,</span>
    {
      <span class="token string">&quot;join_optimization&quot;</span>: {			<span class="token comment">--SQL优化阶段</span>
        <span class="token string">&quot;select#&quot;</span>: <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">&quot;steps&quot;</span>: <span class="token punctuation">[</span>
          {
            <span class="token string">&quot;condition_processing&quot;</span>: {    <span class="token comment">--条件处理</span>
              <span class="token string">&quot;condition&quot;</span>: <span class="token string">&quot;WHERE&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;original_condition&quot;</span>: <span class="token string">&quot;((`t1`.`a` &gt; 900) and (`t1`.`b` &gt; 910))&quot;</span><span class="token punctuation">,</span>        <span class="token comment">--原始条件</span>
              <span class="token string">&quot;steps&quot;</span>: <span class="token punctuation">[</span>
                {
                  <span class="token string">&quot;transformation&quot;</span>: <span class="token string">&quot;equality_propagation&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;resulting_condition&quot;</span>: <span class="token string">&quot;((`t1`.`a` &gt; 900) and (`t1`.`b` &gt; 910))&quot;</span> 		<span class="token comment">--等值传递转换</span>
                }<span class="token punctuation">,</span>
                {
                  <span class="token string">&quot;transformation&quot;</span>: <span class="token string">&quot;constant_propagation&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;resulting_condition&quot;</span>: <span class="token string">&quot;((`t1`.`a` &gt; 900) and (`t1`.`b` &gt; 910))&quot;</span>       <span class="token comment">--常量传递转换</span>
                }<span class="token punctuation">,</span>
                {
                  <span class="token string">&quot;transformation&quot;</span>: <span class="token string">&quot;trivial_condition_removal&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;resulting_condition&quot;</span>: <span class="token string">&quot;((`t1`.`a` &gt; 900) and (`t1`.`b` &gt; 910))&quot;</span>        <span class="token comment">--去除没有的条件后的结构</span>
                }
              <span class="token punctuation">]</span> <span class="token comment">/* steps */</span>
            } <span class="token comment">/* condition_processing */</span>
          }<span class="token punctuation">,</span>
          {
            <span class="token string">&quot;substitute_generated_columns&quot;</span>: {
            } <span class="token comment">/* substitute_generated_columns */</span>   <span class="token comment">--替换虚拟生成列</span>
          }<span class="token punctuation">,</span>
          {
            <span class="token string">&quot;table_dependencies&quot;</span>: <span class="token punctuation">[</span>		<span class="token comment">--表依赖详情</span>
              {
                <span class="token string">&quot;table&quot;</span>: <span class="token string">&quot;`t1`&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;row_may_be_null&quot;</span>: <span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token string">&quot;map_bit&quot;</span>: <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token string">&quot;depends_on_map_bits&quot;</span>: <span class="token punctuation">[</span>
                <span class="token punctuation">]</span> <span class="token comment">/* depends_on_map_bits */</span>
              }
            <span class="token punctuation">]</span> <span class="token comment">/* table_dependencies */</span>
          }<span class="token punctuation">,</span>
          {
            <span class="token string">&quot;ref_optimizer_key_uses&quot;</span>: <span class="token punctuation">[</span>
            <span class="token punctuation">]</span> <span class="token comment">/* ref_optimizer_key_uses */</span>
          }<span class="token punctuation">,</span>
          {
            <span class="token string">&quot;rows_estimation&quot;</span>: <span class="token punctuation">[</span>	<span class="token comment">--预估表的访问成本</span>
              {
                <span class="token string">&quot;table&quot;</span>: <span class="token string">&quot;`t1`&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;range_analysis&quot;</span>: {
                  <span class="token string">&quot;table_scan&quot;</span>: {
                    <span class="token string">&quot;rows&quot;</span>: <span class="token number">1000</span><span class="token punctuation">,</span>       <span class="token comment">--扫描行数</span>
                    <span class="token string">&quot;cost&quot;</span>: <span class="token number">207.1</span>       <span class="token comment">--成本</span>
                  } <span class="token comment">/* table_scan */</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;potential_range_indexes&quot;</span>: <span class="token punctuation">[</span>    <span class="token comment">--分析可能使用的索引</span>
                    {
                      <span class="token string">&quot;index&quot;</span>: <span class="token string">&quot;PRIMARY&quot;</span><span class="token punctuation">,</span>
                      <span class="token string">&quot;usable&quot;</span>: <span class="token boolean">false</span><span class="token punctuation">,</span>       <span class="token comment">--为false，说明主键索引不可用</span>
                      <span class="token string">&quot;cause&quot;</span>: <span class="token string">&quot;not_applicable&quot;</span>
                    }<span class="token punctuation">,</span>
                    {
                      <span class="token string">&quot;index&quot;</span>: <span class="token string">&quot;idx_a&quot;</span><span class="token punctuation">,</span>      <span class="token comment">--可能使用索引idx_a</span>
                      <span class="token string">&quot;usable&quot;</span>: <span class="token boolean">true</span><span class="token punctuation">,</span>
                      <span class="token string">&quot;key_parts&quot;</span>: <span class="token punctuation">[</span>
                        <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;id&quot;</span>
                      <span class="token punctuation">]</span> <span class="token comment">/* key_parts */</span>
                    }<span class="token punctuation">,</span>
                    {
                      <span class="token string">&quot;index&quot;</span>: <span class="token string">&quot;idx_b&quot;</span><span class="token punctuation">,</span>      <span class="token comment">--可能使用索引idx_b</span>
                      <span class="token string">&quot;usable&quot;</span>: <span class="token boolean">true</span><span class="token punctuation">,</span>
                      <span class="token string">&quot;key_parts&quot;</span>: <span class="token punctuation">[</span>
                        <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;id&quot;</span>
                      <span class="token punctuation">]</span> <span class="token comment">/* key_parts */</span>
                    }
                  <span class="token punctuation">]</span> <span class="token comment">/* potential_range_indexes */</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;setup_range_conditions&quot;</span>: <span class="token punctuation">[</span>
                  <span class="token punctuation">]</span> <span class="token comment">/* setup_range_conditions */</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;group_index_range&quot;</span>: {
                    <span class="token string">&quot;chosen&quot;</span>: <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;cause&quot;</span>: <span class="token string">&quot;not_group_by_or_distinct&quot;</span>
                  } <span class="token comment">/* group_index_range */</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;analyzing_range_alternatives&quot;</span>: { <span class="token comment">--分析各索引的成本</span>
                    <span class="token string">&quot;range_scan_alternatives&quot;</span>: <span class="token punctuation">[</span>
                      {
                        <span class="token string">&quot;index&quot;</span>: <span class="token string">&quot;idx_a&quot;</span><span class="token punctuation">,</span>	<span class="token comment">--使用索引idx_a的成本</span>
                        <span class="token string">&quot;ranges&quot;</span>: <span class="token punctuation">[</span>
                          <span class="token string">&quot;900 &lt; a&quot;</span>			<span class="token comment">--使用索引idx_a的范围</span>
                        <span class="token punctuation">]</span> <span class="token comment">/* ranges */</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;index_dives_for_eq_ranges&quot;</span>: <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">--是否使用index dive（详细描述请看下方的知识扩展）</span>
                        <span class="token string">&quot;rowid_ordered&quot;</span>: <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">--使用该索引获取的记录是否按照主键排序</span>
                        <span class="token string">&quot;using_mrr&quot;</span>: <span class="token boolean">false</span><span class="token punctuation">,</span>  	<span class="token comment">--是否使用mrr</span>
                        <span class="token string">&quot;index_only&quot;</span>: <span class="token boolean">false</span><span class="token punctuation">,</span>    <span class="token comment">--是否使用覆盖索引</span>
                        <span class="token string">&quot;rows&quot;</span>: <span class="token number">100</span><span class="token punctuation">,</span>            <span class="token comment">--使用该索引获取的记录数</span>
                        <span class="token string">&quot;cost&quot;</span>: <span class="token number">121.01</span><span class="token punctuation">,</span>         <span class="token comment">--使用该索引的成本</span>
                        <span class="token string">&quot;chosen&quot;</span>: <span class="token boolean">true</span>          <span class="token comment">--可能选择该索引</span>
                      }<span class="token punctuation">,</span>
                      {
                        <span class="token string">&quot;index&quot;</span>: <span class="token string">&quot;idx_b&quot;</span><span class="token punctuation">,</span>       <span class="token comment">--使用索引idx_b的成本</span>
                        <span class="token string">&quot;ranges&quot;</span>: <span class="token punctuation">[</span>
                          <span class="token string">&quot;910 &lt; b&quot;</span>
                        <span class="token punctuation">]</span> <span class="token comment">/* ranges */</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;index_dives_for_eq_ranges&quot;</span>: <span class="token boolean">true</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;rowid_ordered&quot;</span>: <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;using_mrr&quot;</span>: <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;index_only&quot;</span>: <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;rows&quot;</span>: <span class="token number">90</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;cost&quot;</span>: <span class="token number">109.01</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;chosen&quot;</span>: <span class="token boolean">true</span>             <span class="token comment">--也可能选择该索引</span>
                      }
                    <span class="token punctuation">]</span> <span class="token comment">/* range_scan_alternatives */</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;analyzing_roworder_intersect&quot;</span>: { <span class="token comment">--分析使用索引合并的成本</span>
                      <span class="token string">&quot;usable&quot;</span>: <span class="token boolean">false</span><span class="token punctuation">,</span>
                      <span class="token string">&quot;cause&quot;</span>: <span class="token string">&quot;too_few_roworder_scans&quot;</span>
                    } <span class="token comment">/* analyzing_roworder_intersect */</span>
                  } <span class="token comment">/* analyzing_range_alternatives */</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;chosen_range_access_summary&quot;</span>: {  <span class="token comment">--确认最优方法</span>
                    <span class="token string">&quot;range_access_plan&quot;</span>: {
                      <span class="token string">&quot;type&quot;</span>: <span class="token string">&quot;range_scan&quot;</span><span class="token punctuation">,</span>
                      <span class="token string">&quot;index&quot;</span>: <span class="token string">&quot;idx_b&quot;</span><span class="token punctuation">,</span>
                      <span class="token string">&quot;rows&quot;</span>: <span class="token number">90</span><span class="token punctuation">,</span>
                      <span class="token string">&quot;ranges&quot;</span>: <span class="token punctuation">[</span>
                        <span class="token string">&quot;910 &lt; b&quot;</span>
                      <span class="token punctuation">]</span> <span class="token comment">/* ranges */</span>
                    } <span class="token comment">/* range_access_plan */</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;rows_for_plan&quot;</span>: <span class="token number">90</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;cost_for_plan&quot;</span>: <span class="token number">109.01</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;chosen&quot;</span>: <span class="token boolean">true</span>
                  } <span class="token comment">/* chosen_range_access_summary */</span>
                } <span class="token comment">/* range_analysis */</span>
              }
            <span class="token punctuation">]</span> <span class="token comment">/* rows_estimation */</span>
          }<span class="token punctuation">,</span>
          {
            <span class="token string">&quot;considered_execution_plans&quot;</span>: <span class="token punctuation">[</span>  <span class="token comment">--考虑的执行计划</span>
              {
                <span class="token string">&quot;plan_prefix&quot;</span>: <span class="token punctuation">[</span>
                <span class="token punctuation">]</span> <span class="token comment">/* plan_prefix */</span><span class="token punctuation">,</span>
                <span class="token string">&quot;table&quot;</span>: <span class="token string">&quot;`t1`&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;best_access_path&quot;</span>: {          <span class="token comment">--最优的访问路径</span>
                  <span class="token string">&quot;considered_access_paths&quot;</span>: <span class="token punctuation">[</span> <span class="token comment">--决定的访问路径</span>
                    {
                      <span class="token string">&quot;rows_to_scan&quot;</span>: <span class="token number">90</span><span class="token punctuation">,</span>      <span class="token comment">--扫描的行数</span>
                      <span class="token string">&quot;access_type&quot;</span>: <span class="token string">&quot;range&quot;</span><span class="token punctuation">,</span>  <span class="token comment">--访问类型：为range</span>
                      <span class="token string">&quot;range_details&quot;</span>: {
                        <span class="token string">&quot;used_index&quot;</span>: <span class="token string">&quot;idx_b&quot;</span>  <span class="token comment">--使用的索引为：idx_b</span>
                      } <span class="token comment">/* range_details */</span><span class="token punctuation">,</span>
                      <span class="token string">&quot;resulting_rows&quot;</span>: <span class="token number">90</span><span class="token punctuation">,</span>    <span class="token comment">--结果行数</span>
                      <span class="token string">&quot;cost&quot;</span>: <span class="token number">127.01</span><span class="token punctuation">,</span>          <span class="token comment">--成本</span>
                      <span class="token string">&quot;chosen&quot;</span>: <span class="token boolean">true</span><span class="token punctuation">,</span>		   <span class="token comment">--确定选择</span>
                      <span class="token string">&quot;use_tmp_table&quot;</span>: <span class="token boolean">true</span>
                    }
                  <span class="token punctuation">]</span> <span class="token comment">/* considered_access_paths */</span>
                } <span class="token comment">/* best_access_path */</span><span class="token punctuation">,</span>
                <span class="token string">&quot;condition_filtering_pct&quot;</span>: <span class="token number">100</span><span class="token punctuation">,</span>
                <span class="token string">&quot;rows_for_plan&quot;</span>: <span class="token number">90</span><span class="token punctuation">,</span>
                <span class="token string">&quot;cost_for_plan&quot;</span>: <span class="token number">127.01</span><span class="token punctuation">,</span>
                <span class="token string">&quot;sort_cost&quot;</span>: <span class="token number">90</span><span class="token punctuation">,</span>
                <span class="token string">&quot;new_cost_for_plan&quot;</span>: <span class="token number">217.01</span><span class="token punctuation">,</span>
                <span class="token string">&quot;chosen&quot;</span>: <span class="token boolean">true</span>
              }
            <span class="token punctuation">]</span> <span class="token comment">/* considered_execution_plans */</span>
          }<span class="token punctuation">,</span>
          {
            <span class="token string">&quot;attaching_conditions_to_tables&quot;</span>: {  <span class="token comment">--尝试添加一些其他的查询条件</span>
              <span class="token string">&quot;original_condition&quot;</span>: <span class="token string">&quot;((`t1`.`a` &gt; 900) and (`t1`.`b` &gt; 910))&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;attached_conditions_computation&quot;</span>: <span class="token punctuation">[</span>
              <span class="token punctuation">]</span> <span class="token comment">/* attached_conditions_computation */</span><span class="token punctuation">,</span>
              <span class="token string">&quot;attached_conditions_summary&quot;</span>: <span class="token punctuation">[</span>
                {
                  <span class="token string">&quot;table&quot;</span>: <span class="token string">&quot;`t1`&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;attached&quot;</span>: <span class="token string">&quot;((`t1`.`a` &gt; 900) and (`t1`.`b` &gt; 910))&quot;</span>
                }
              <span class="token punctuation">]</span> <span class="token comment">/* attached_conditions_summary */</span>
            } <span class="token comment">/* attaching_conditions_to_tables */</span>
          }<span class="token punctuation">,</span>
          {
            <span class="token string">&quot;clause_processing&quot;</span>: {
              <span class="token string">&quot;clause&quot;</span>: <span class="token string">&quot;ORDER BY&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;original_clause&quot;</span>: <span class="token string">&quot;`t1`.`a`&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;items&quot;</span>: <span class="token punctuation">[</span>
                {
                  <span class="token string">&quot;item&quot;</span>: <span class="token string">&quot;`t1`.`a`&quot;</span>
                }
              <span class="token punctuation">]</span> <span class="token comment">/* items */</span><span class="token punctuation">,</span>
              <span class="token string">&quot;resulting_clause_is_simple&quot;</span>: <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token string">&quot;resulting_clause&quot;</span>: <span class="token string">&quot;`t1`.`a`&quot;</span>
            } <span class="token comment">/* clause_processing */</span>
          }<span class="token punctuation">,</span>
          {
            <span class="token string">&quot;reconsidering_access_paths_for_index_ordering&quot;</span>: {
              <span class="token string">&quot;clause&quot;</span>: <span class="token string">&quot;ORDER BY&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;index_order_summary&quot;</span>: {
                <span class="token string">&quot;table&quot;</span>: <span class="token string">&quot;`t1`&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;index_provides_order&quot;</span>: <span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token string">&quot;order_direction&quot;</span>: <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;index&quot;</span>: <span class="token string">&quot;idx_b&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;plan_changed&quot;</span>: <span class="token boolean">false</span>
              } <span class="token comment">/* index_order_summary */</span>
            } <span class="token comment">/* reconsidering_access_paths_for_index_ordering */</span>
          }<span class="token punctuation">,</span>
          {
            <span class="token string">&quot;refine_plan&quot;</span>: <span class="token punctuation">[</span>          <span class="token comment">--改进的执行计划</span>
              {
                <span class="token string">&quot;table&quot;</span>: <span class="token string">&quot;`t1`&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;pushed_index_condition&quot;</span>: <span class="token string">&quot;(`t1`.`b` &gt; 910)&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;table_condition_attached&quot;</span>: <span class="token string">&quot;(`t1`.`a` &gt; 900)&quot;</span>
              }
            <span class="token punctuation">]</span> <span class="token comment">/* refine_plan */</span>
          }
        <span class="token punctuation">]</span> <span class="token comment">/* steps */</span>
      } <span class="token comment">/* join_optimization */</span>
    }<span class="token punctuation">,</span>
    {
      <span class="token string">&quot;join_execution&quot;</span>: {             <span class="token comment">--SQL执行阶段</span>
        <span class="token string">&quot;select#&quot;</span>: <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">&quot;steps&quot;</span>: <span class="token punctuation">[</span>
          {
            <span class="token string">&quot;filesort_information&quot;</span>: <span class="token punctuation">[</span>
              {
                <span class="token string">&quot;direction&quot;</span>: <span class="token string">&quot;asc&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;table&quot;</span>: <span class="token string">&quot;`t1`&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;field&quot;</span>: <span class="token string">&quot;a&quot;</span>
              }
            <span class="token punctuation">]</span> <span class="token comment">/* filesort_information */</span><span class="token punctuation">,</span>
            <span class="token string">&quot;filesort_priority_queue_optimization&quot;</span>: {
              <span class="token string">&quot;usable&quot;</span>: <span class="token boolean">false</span><span class="token punctuation">,</span>             <span class="token comment">--未使用优先队列优化排序</span>
              <span class="token string">&quot;cause&quot;</span>: <span class="token string">&quot;not applicable (no LIMIT)&quot;</span>     <span class="token comment">--未使用优先队列排序的原因是没有limit</span>
            } <span class="token comment">/* filesort_priority_queue_optimization */</span><span class="token punctuation">,</span>
            <span class="token string">&quot;filesort_execution&quot;</span>: <span class="token punctuation">[</span>
            <span class="token punctuation">]</span> <span class="token comment">/* filesort_execution */</span><span class="token punctuation">,</span>
            <span class="token string">&quot;filesort_summary&quot;</span>: {           <span class="token comment">--排序详情</span>
              <span class="token string">&quot;rows&quot;</span>: <span class="token number">90</span><span class="token punctuation">,</span>
              <span class="token string">&quot;examined_rows&quot;</span>: <span class="token number">90</span><span class="token punctuation">,</span>          <span class="token comment">--参与排序的行数</span>
              <span class="token string">&quot;number_of_tmp_files&quot;</span>: <span class="token number">0</span><span class="token punctuation">,</span>     <span class="token comment">--排序过程中使用的临时文件数</span>
              <span class="token string">&quot;sort_buffer_size&quot;</span>: <span class="token number">115056</span><span class="token punctuation">,</span>
              <span class="token string">&quot;sort_mode&quot;</span>: <span class="token string">&quot;&lt;sort_key, additional_fields&gt;&quot;</span>   <span class="token comment">--排序模式（详解请看下方知识扩展）</span>
            } <span class="token comment">/* filesort_summary */</span>
          }
        <span class="token punctuation">]</span> <span class="token comment">/* steps */</span>
      } <span class="token comment">/* join_execution */</span>
    }
  <span class="token punctuation">]</span> <span class="token comment">/* steps */</span>
}
MISSING_BYTES_BEYOND_MAX_MEM_SIZE: <span class="token number">0</span>	<span class="token comment">--该字段表示分析过程丢弃的文本字节大小，本例为0，说明没丢弃任何文本</span>
          INSUFFICIENT_PRIVILEGES: <span class="token number">0</span>    <span class="token comment">--查看trace的权限是否不足，0表示有权限查看trace详情</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token comment">------------------------------------------------</span>
<span class="token comment">------------------------------------------------</span>


mysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> <span class="token keyword">session</span> optimizer_trace<span class="token operator">=</span><span class="token string">&quot;enabled=off&quot;</span><span class="token punctuation">;</span>
<span class="token comment">/* 及时关闭trace */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br></div></div><p>这里对上方的执行字段详细描述一下：</p> <p>TRACE 字段中整个文本大致分为三个过程。</p> <ul><li>准备阶段：对应文本中的 join_preparation</li> <li>优化阶段：对应文本中的 join_optimization</li> <li>执行阶段：对应文本中的 join_execution</li></ul> <p>使用时，重点关注优化阶段和执行阶段。</p> <p>由此例可以看出：</p> <ul><li>在 trace 结果的  analyzing_range_alternatives 这一项可以看到：使用索引 idx_a 的成本为 121.01，使用索引 idx_b  的成本为 109.01，显然使用索引 idx_b 的成本要低些，因此优化器选择了 idx_b 索引；</li> <li>在 trace 结果的 filesort_summary 这一项可以看到：排序模式为&lt;sort_key, additional_fields&gt;，表示使用的是单路排序，即一次性取出满足条件行的所有字段，然后在 sort buffer 中进行排序。</li></ul> <blockquote><p>知识扩展：</p> <p><strong>知识点一：MySQL 常见排序模式：</strong></p> <ul><li>&lt; sort_key, rowid &gt;双路排序（又叫回表排序模式）：是首先根据相应的条件取出相应的排序字段和可以直接定位行数据的行 ID，然后在 sort buffer 中进行排序，排序完后需要再次取回其它需要的字段；</li> <li>&lt; sort_key, additional_fields &gt;单路排序：是一次性取出满足条件行的所有字段，然后在sort buffer中进行排序；</li> <li>&lt; sort_key, packed_additional_fields &gt;打包数据排序模式：将 char 和 varchar 字段存到 sort buffer 中时，更加紧缩。</li></ul> <p>三种排序模式比较：</p> <p>第二种模式相对第一种模式，避免了二次回表，可以理解为用空间换时间。由于 sort buffer 有限，如果需要查询的数据比较大的话，会增加磁盘排序时间，效率可能比第一种方式更低。</p> <p>MySQL  提供了一个参数：max_length_for_sort_data，当“排序的键值对大小” &gt;  max_length_for_sort_data 时，MySQL 认为磁盘外部排序的 IO  效率不如回表的效率，会选择第一种排序模式；否则，会选择第二种模式。</p> <p>第三种模式主要解决变长字符数据存储空间浪费的问题。</p> <p><strong>知识点二：优化器在估计符合条件的行数时有两个选择：</strong></p> <ul><li>index diver：dive 到 index 中利用索引完成元组数的估算；特点是速度慢，但可以得到精确的值；</li> <li>index statistics：使用索引的统计数值，进行估算；特点是速度快，但是值不一定准确。</li></ul></blockquote> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ul><li><p>explain：获取 MySQL 中 SQL 语句的执行计划，比如语句是否使用了关联查询、是否使用了索引、扫描行数等；</p></li> <li><p>profile：可以清楚了解到SQL到底慢在哪个环节；</p></li> <li><p>trace：查看优化器如何选择执行计划，获取每个可能的索引选择的代价。</p></li> <li><p>一种方法是查看慢查询日志</p></li> <li><p>另一种方法是 show process 查看正在执行的 SQL</p></li></ul> <p>再讲到通过 explain 分析慢 SQL，explain 会返回很多字段，其中 select_type、type、key、rows、Extra 是重点关注项。</p> <p>在工作中及面试时，SQL 性能优化都是我们经常遇到的问题，要想做好性能优化，我们必须学会使用 SQL 优化时需要的工具，进行定位和分析。由于篇幅的问题，本小节只介绍了  explain 工具的使用，在下节将补充另外两种分析慢查询的工具：show profile 和 trace。在后面我会再讲解 SQL  优化的一些知识点，相信小伙伴们 SQL 性能优化时一定可以越来越熟练。</p> <h2 id="_5-参考资料"><a href="#_5-参考资料" class="header-anchor">#</a> 5 参考资料</h2> <p>《深入浅出 MySQL》（第2版）：第 18 章第 1 节
MySQL 5.7官方文档：https://dev.mysql.com/doc/internals/en/tracing-example.html</p></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">12/12/2022, 9:46:20 AM</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/678015/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">idea基础配置</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/678015/" class="prev">idea基础配置</a></span> <!----></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="https://github.com/ily55421" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="mailto:ily55421@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://gitee.com/ily55421" title="Gitee" target="_blank" class="iconfont icon-gitee"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2022
    <span>ily55421 </span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.7d303452.js" defer></script><script src="/assets/js/5.5ca26c73.js" defer></script><script src="/assets/js/43.95fe06e5.js" defer></script>
  </body>
</html>
